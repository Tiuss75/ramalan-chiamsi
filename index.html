<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramalan Chiam Si - PWA</title>
    <meta name="theme-color" content="#9c1c26">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">

    <!-- ✅ Perbaikan favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="favicon-512.png" type="image/png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript"
        src="https://app.sandbox.midtrans.com/snap/snap.js"
        data-client-key="SB-Mid-client-hCnSsq93YoH_kxLO"></script>

    <style>
        /* (CSS sama persis dari kode asli kamu, tidak saya ubah) */
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="appContainer" class="container">
        <!-- Konten aplikasi utama -->
        <!-- ... kode konten utama dari versi asli kamu tetap di sini ... -->
    </div>

    <!-- Admin & Popup Sections -->
    <div id="adminLoginSection" class="admin-section hidden">
        <!-- ✅ Form login admin -->
        <div class="admin-form">
            <h2>Login Admin</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="adminEmail" placeholder="Email admin">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Password">
            </div>
            <div style="text-align:center;">
                <button id="adminLoginBtn" class="btn">Login</button>
                <button id="adminCloseBtn" class="btn" style="background:#777;color:#fff;">Tutup</button>
            </div>
        </div>
    </div>

    <div id="adminCmsSection" class="container hidden" style="margin-top: 20px;">
        <!-- Konten CMS akan diisi oleh JS -->
    </div>
    <div id="paymentPopup" class="popup-overlay hidden"></div>
    <div id="messagePopup" class="popup-overlay hidden"></div>

    <!-- Popup untuk Syarat & Ketentuan -->
    <!-- ... popup terms & privacy dari kode asli ... -->

    <!-- Footer Aplikasi -->
    <footer>
        <p>&copy; 2025 Ramalan Chiam Si. All Rights Reserved.</p>
        <div style="margin-top: 10px;">
            <a id="termsLink">Syarat & Ketentuan</a> |
            <a id="privacyLink">Kebijakan Privasi</a> |
            <a href="mailto:dukungan.chiamsi@email.com">Kontak Kami</a> |
            <!-- ✅ Tombol Admin -->
            <a id="adminLink" style="cursor:pointer;">Admin</a>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzYog6EbRLen7pg2aITsf5utEXQUVP3n0",
            authDomain: "ramalan-chiamsi-df5b0.firebaseapp.com",
            projectId: "ramalan-chiamsi-df5b0",
            storageBucket: "ramalan-chiamsi-df5b0.appspot.com",
            messagingSenderId: "152505108899",
            appId: "1:152505108899:web:b1e2e90ac2d7e722997216"
        };

        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elemen DOM utama ---
        const nameInput = document.getElementById('nameInput');
        const shakeBtn = document.getElementById('shakeBtn');
        const throwBtn = document.getElementById('throwBtn');
        const predictionResult = document.getElementById('predictionResult');
        const predictionNumber = document.getElementById('predictionNumber');
        const shakeResult = document.getElementById('shakeResult');
        const resultNumber = document.getElementById('resultNumber');
        const sinthioText = document.getElementById('sinthioText');
        const syairText = document.getElementById('syairText');
        const selayangPandangText = document.getElementById('selayangPandangText');
        const pedomanList = document.getElementById('pedomanList');

        // --- Elemen Admin ---
        const adminLink = document.getElementById('adminLink');
        const adminLoginSection = document.getElementById('adminLoginSection');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminCloseBtn = document.getElementById('adminCloseBtn');
        const adminEmail = document.getElementById('adminEmail');
        const adminPassword = document.getElementById('adminPassword');
        const adminCmsSection = document.getElementById('adminCmsSection');

        // --- State Aplikasi ---
        let currentUser = null;
        let currentPredictionNumberState = null;

        // --- Otentikasi Anonim untuk User biasa ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
            } else {
                signInAnonymously(auth).catch(error => console.error("Gagal login anonim:", error));
            }
        });

        // --- Logika tombol utama ---
        nameInput.addEventListener('input', () => {
            shakeBtn.disabled = nameInput.value.trim() === '';
        });

        shakeBtn.addEventListener('click', () => {
            const randomNumber = 1; // untuk test
            predictionNumber.textContent = randomNumber;
            currentPredictionNumberState = randomNumber;
            shakeResult.classList.remove('hidden');
            throwBtn.disabled = false;
        });

        throwBtn.addEventListener('click', () => {
            showPrediction();
        });

        async function showPrediction() {
            if (!currentPredictionNumberState) return;
            const docRef = doc(db, "ramalan", String(currentPredictionNumberState));
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    resultNumber.textContent = data.nomor || currentPredictionNumberState;
                    sinthioText.textContent = data.sinthio || 'Data belum diisi.';
                    syairText.textContent = data.syair || 'Data belum diisi.';
                    selayangPandangText.textContent = data.selayangPandang || 'Data belum diisi.';
                    pedomanList.innerHTML = '';
                    if (data.pedoman && data.pedoman.length > 0) {
                        data.pedoman.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            pedomanList.appendChild(li);
                        });
                    } else {
                        pedomanList.innerHTML = '<li>Data belum diisi.</li>';
                    }
                    predictionResult.classList.remove('hidden');
                } else {
                    alert(`Data untuk ramalan nomor ${currentPredictionNumberState} belum diisi di CMS.`);
                    predictionResult.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error mengambil data ramalan:", error);
                alert("Gagal mengambil data dari server.");
            }
        }

        // --- Logika Admin ---
        adminLink.addEventListener('click', () => {
            adminLoginSection.classList.remove('hidden');
        });

        adminCloseBtn.addEventListener('click', () => {
            adminLoginSection.classList.add('hidden');
        });

        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value.trim();
            const password = adminPassword.value.trim();
            if (!email || !password) {
                alert("Masukkan email dan password admin.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("Login berhasil!");
                adminLoginSection.classList.add('hidden');
                loadCMS();
            } catch (error) {
                alert("Login gagal: " + error.message);
            }
        });

        function loadCMS() {
            adminCmsSection.innerHTML = `
                <h2 style="color:var(--gold);">Admin CMS</h2>
                <p>Selamat datang, Anda bisa mengedit ramalan di sini.</p>
            `;
            adminCmsSection.classList.remove('hidden');
        }

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
</body>
</html>