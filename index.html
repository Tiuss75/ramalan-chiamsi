<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramalan Chiam Si - PWA</title>
    <meta name="theme-color" content="#9c1c26">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" href="https://placehold.co/192x192/9c1c26/FFFFFF?text=CS" type="image/png">
    <link rel="apple-touch-icon" href="https://placehold.co/512x512/9c1c26/FFFFFF?text=CS" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Import Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary-red: #9c1c26;
            --dark-red: #7a0a14;
            --gold: #d4af37;
            --light-gold: #f8ecc2;
            --dark-gold: #b8860b;
            --black: #2c2416;
            --white: #f8f4e9;
            --font-main: 'Inter', sans-serif;
            --font-display: 'Noto Serif SC', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--primary-red);
            background-image:
                linear-gradient(135deg, rgba(122, 10, 20, 0.8), rgba(28, 5, 7, 0.9));
            color: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(44, 36, 22, 0.85);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            border: 3px solid var(--gold);
            backdrop-filter: blur(5px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            color: var(--gold);
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.7);
        }

        .step {
            background: rgba(122, 10, 20, 0.6);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid var(--dark-gold);
        }

        .step-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            color: var(--gold);
        }

        .step-title i {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--black);
            border: 2px solid var(--gold);
        }

        .step-title h2 {
            font-size: 1.5rem;
        }

        .name-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: 2px solid var(--dark-gold);
            background-color: var(--light-gold);
            color: var(--black);
            font-size: 1.1rem;
        }

        .ciamsi-shaker-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 220px;
            position: relative;
            margin: 20px 0;
        }

        .ciamsi-container {
            width: 100px;
            height: 180px;
            position: relative;
        }

        .ciamsi-body {
            width: 100%; height: 100%;
            background: linear-gradient(145deg, #6d1a21, #a8323c);
            border-radius: 15px 15px 10px 10px;
            border: 4px solid #501015;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.4);
            position: absolute; bottom: 0;
            display: flex; justify-content: center; align-items: center;
        }

        .ciamsi-logo {
            font-family: var(--font-display);
            font-size: 50px; color: var(--gold);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .falling-stick {
            width: 8px; height: 130px;
            background: linear-gradient(#deb887, #b8860b);
            border: 1px solid #8B4513; border-radius: 5px;
            position: absolute; bottom: 180px;
            opacity: 0; transform-origin: bottom center;
        }

        .shake-animation { animation: container-shake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes container-shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg); }
            20%, 80% { transform: translate3d(2px, 0, 0) rotate(2deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg); }
            40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); }
        }

        .fall-animation { animation: stick-fall 1s forwards ease-in; }
        @keyframes stick-fall {
            0% { opacity: 1; transform: translateY(-180px) translateX(20px) rotate(0deg); }
            100% { opacity: 1; transform: translateY(220px) translateX(70px) rotate(110deg); }
        }
        
        .puak-poi-container { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
        .puak-poi {
            width: 70px; height: 35px; background: #d2b48c;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 1.8rem;
            color: var(--black); font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .throw-animation { animation: throw 0.8s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes throw {
            0% { transform: translateY(0) rotate(0deg); }
            30% { transform: translateY(-80px) rotate(180deg); }
            70% { transform: translateY(40px) rotate(360deg); }
            100% { transform: translateY(0) rotate(720deg); }
        }

        .btn {
            background: var(--gold); color: var(--black);
            border: none; padding: 12px 25px; font-size: 1.1rem;
            font-weight: 600; border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); text-decoration: none;
        }
        .btn:hover { background: var(--light-gold); transform: translateY(-3px); }
        .btn:disabled { background: #777; color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .prediction-card {
            background: var(--white); color: var(--black);
            border-radius: 15px; padding: 25px; margin: 30px 0;
            border: 3px solid var(--gold);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gold);
        }
        .card-title { font-size: 1.5rem; color: var(--primary-red); font-weight: 700; }
        .card-number {
            background: var(--gold); color: var(--black);
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 700;
        }
        .prediction-section { margin-bottom: 15px; }
        .prediction-section h3 {
            font-family: var(--font-display);
            color: var(--dark-red); margin-bottom: 8px;
            border-bottom: 1px solid var(--light-gold); padding-bottom: 5px;
        }
        .prediction-section p, .prediction-section ul { white-space: pre-wrap; line-height: 1.6; }
        .pedoman-jawaban ul { list-style: none; padding-left: 0; }
        .pedoman-jawaban li { margin-bottom: 5px; }
        
        .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .whatsapp-share { background: #25D366; color: white; }
        .whatsapp-share:hover { background: #128C7E; }
        .download-btn { background-color: var(--dark-red); color: var(--white); }
        
        .hidden { display: none !important; }

        /* Admin & Popup Styles */
        .admin-section, .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; padding: 20px;
        }
        .admin-form, .popup-content {
            background: var(--white); color: var(--black);
            padding: 30px; border-radius: 15px;
            width: 100%; max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .admin-form h2, .popup-content h2 { color: var(--dark-red); margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid #ccc; font-size: 1rem;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .popup-content p { margin-bottom: 20px; text-align: center; line-height: 1.5; }
        .popup-buttons { display: flex; justify-content: center; gap: 15px; }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="appContainer" class="container">
        <div class="header">
            <h1>Ramalan Chiam Si</h1>
            <p>Petunjuk ilahi untuk langkah hidup Anda</p>
        </div>

        <!-- Step 1: User Data -->
        <div class="step">
            <div class="step-title"><i class="fas fa-user"></i><h2>Data Diri</h2></div>
            <input type="text" id="nameInput" placeholder="Ketik nama Anda..." class="name-input">
        </div>

        <!-- Step 2: Shake Ciam Si -->
        <div class="step">
            <div class="step-title"><i class="fas fa-praying-hands"></i><h2>Kocok Tabung</h2></div>
            <p>Fokuskan pikiran, lalu kocok tabung untuk mendapat nomor ramalan.</p>
            <div class="ciamsi-shaker-container">
                <div class="ciamsi-container" id="ciamsiContainer">
                    <div class="ciamsi-body"><div class="ciamsi-logo">簽</div></div>
                </div>
                <div class="falling-stick" id="fallingStick"></div>
            </div>
            <div style="text-align: center;">
                <button id="shakeBtn" class="btn" disabled><i class="fas fa-hand-point-right"></i> Kocok</button>
            </div>
            <div class="result-container hidden" id="shakeResult" style="text-align:center; margin-top:15px;">
                <p>Anda mendapatkan nomor ramalan:</p>
                <div class="result-number" id="predictionNumber" style="font-size: 2rem; font-weight: bold; color: var(--gold);">-</div>
            </div>
        </div>

        <!-- Step 3: Throw Puak Poi -->
        <div class="step">
            <div class="step-title"><i class="fas fa-moon"></i><h2>Lempar Puak Poi</h2></div>
            <p>Lemparkan Puak Poi untuk memohon restu dewa.</p>
            <div class="puak-poi-container">
                <div class="puak-poi" id="puakpoi1">-</div>
                <div class="puak-poi" id="puakpoi2">-</div>
            </div>
            <div class="throw-counter" style="text-align:center; margin-bottom:15px;">
                Lemparan ke: <span id="throwCount">0</span>/3
            </div>
            <div style="text-align: center;">
                <button id="throwBtn" class="btn" disabled><i class="fas fa-hand-point-right"></i> Lempar</button>
            </div>
            <div class="result-container hidden" id="throwResult" style="text-align:center; margin-top:15px;">
                <p id="throwResultText">Hasil lemparan: -</p>
            </div>
        </div>

        <!-- Prediction Result -->
        <div class="hidden" id="predictionResult">
            <div class="prediction-card" id="predictionCard">
                <div class="card-header">
                    <div class="card-title">Hasil Ramalan</div>
                    <div class="card-number" id="resultNumber">-</div>
                </div>
                <div class="prediction-section">
                    <h3>Makna Lambang / Sinthio</h3>
                    <p id="sinthioText">-</p>
                </div>
                <div class="prediction-section">
                    <h3>Bunyi Syair</h3>
                    <p id="syairText">-</p>
                </div>
                <div class="prediction-section">
                    <h3>Selayang Pandang</h3>
                    <p id="selayangPandangText">-</p>
                </div>
                <div class="prediction-section pedoman-jawaban">
                    <h3>Pedoman Jawaban</h3>
                    <ul id="pedomanList"></ul>
                </div>
            </div>
            <div class="action-buttons">
                <a href="#" class="btn whatsapp-share" id="whatsappShare"><i class="fab fa-whatsapp"></i> Bagikan</a>
                <button class="btn download-btn" id="downloadBtn"><i class="fas fa-download"></i> Unduh</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Section -->
    <div id="adminLoginSection" class="admin-section hidden">
        <div class="admin-form">
            <h2>Login Admin</h2>
            <div class="form-group">
                <label for="adminEmail">Email</label>
                <input type="email" id="adminEmail" placeholder="admin@email.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" placeholder="******">
            </div>
            <button id="loginBtn" class="btn" style="width: 100%;">Login</button>
        </div>
    </div>

    <!-- Admin CMS Section -->
    <div id="adminCmsSection" class="container hidden" style="margin-top: 20px;">
        <h2>CMS Ramalan Chiam Si <button id="logoutBtn" class="btn" style="float: right;">Logout</button></h2>
        <div class="form-group">
            <label for="ramalanNumberSelect">Pilih Nomor Ramalan</label>
            <select id="ramalanNumberSelect">
                <!-- Options will be generated by JS -->
            </select>
        </div>
        <div class="form-group">
            <label for="sinthioInput">Makna Lambang / Sinthio</label>
            <textarea id="sinthioInput"></textarea>
        </div>
        <div class="form-group">
            <label for="syairInput">Bunyi Syair</label>
            <textarea id="syairInput"></textarea>
        </div>
        <div class="form-group">
            <label for="selayangPandangInput">Selayang Pandang</label>
            <textarea id="selayangPandangInput"></textarea>
        </div>
        <div class="form-group">
            <label for="pedomanInput">Pedoman Jawaban (satu per baris)</label>
            <textarea id="pedomanInput" placeholder="PERDAGANGAN BERJALAN BIASA&#10;MENCARI HARTA BANYAK KOSONG"></textarea>
        </div>
        <button id="saveBtn" class="btn" style="width: 100%;">Simpan Perubahan</button>
    </div>
    
    <!-- Payment Popup -->
    <div id="paymentPopup" class="popup-overlay hidden">
        <div class="popup-content">
            <h2>Tingkatkan Pengalaman Anda!</h2>
            <p>Anda telah mencapai batas penggunaan gratis. Untuk melanjutkan tanpa batas dan mendapatkan ramalan yang lebih akurat, silakan tingkatkan ke paket premium.</p>
            <div class="popup-buttons">
                <button id="upgradeBtn" class="btn">Upgrade Sekarang</button>
                <button id="closePopupBtn" class="btn" style="background-color: var(--dark-red); color: var(--white);">Nanti Saja</button>
            </div>
        </div>
    </div>

    <!-- Generic Message Popup -->
    <div id="messagePopup" class="popup-overlay hidden">
        <div class="popup-content">
            <h2 id="messageTitle">Pemberitahuan</h2>
            <p id="messageText"></p>
            <div class="popup-buttons">
                <button id="closeMessageBtn" class="btn">Tutup</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBzYog6EbRLen7pg2aITsf5utEXQUVP3n0",
                authDomain: "ramalan-chiamsi-df5b0.firebaseapp.com",
                projectId: "ramalan-chiamsi-df5b0",
                storageBucket: "ramalan-chiamsi-df5b0.appspot.com",
                messagingSenderId: "152505108899",
                appId: "1:152505108899:web:b1e2e90ac2d7e722997216"
            };

        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elemen DOM ---
        const appContainer = document.getElementById('appContainer');
        const adminLoginSection = document.getElementById('adminLoginSection');
        const adminCmsSection = document.getElementById('adminCmsSection');
        const nameInput = document.getElementById('nameInput');
        const shakeBtn = document.getElementById('shakeBtn');
        const throwBtn = document.getElementById('throwBtn');
        const shakeResult = document.getElementById('shakeResult');
        const predictionNumber = document.getElementById('predictionNumber');
        const throwResult = document.getElementById('throwResult');
        const throwResultText = document.getElementById('throwResultText');
        const predictionResult = document.getElementById('predictionResult');
        const ciamsiContainer = document.getElementById('ciamsiContainer');
        const fallingStick = document.getElementById('fallingStick');
        const puakpois = [document.getElementById('puakpoi1'), document.getElementById('puakpoi2')];
        const throwCountElement = document.getElementById('throwCount');
        const resultNumber = document.getElementById('resultNumber');
        const sinthioText = document.getElementById('sinthioText');
        const syairText = document.getElementById('syairText');
        const selayangPandangText = document.getElementById('selayangPandangText');
        const pedomanList = document.getElementById('pedomanList');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const ramalanNumberSelect = document.getElementById('ramalanNumberSelect');
        const sinthioInput = document.getElementById('sinthioInput');
        const syairInput = document.getElementById('syairInput');
        const selayangPandangInput = document.getElementById('selayangPandangInput');
        const pedomanInput = document.getElementById('pedomanInput');
        const saveBtn = document.getElementById('saveBtn');
        const paymentPopup = document.getElementById('paymentPopup');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const messagePopup = document.getElementById('messagePopup');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        // --- State Aplikasi ---
        let currentUser = null;
        let currentPredictionNumberState = null;
        let throwCount = 0;
        const maxThrowsFree = 3;
        let noBlessingCounter = 0;
        // **NEW** State untuk melacak status pengguna
        let isPremiumUser = false;
        let hasHadFreeSuccess = false;


        // --- Fungsi Utilitas ---
        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messagePopup.classList.remove('hidden');
        }
        
        closeMessageBtn.addEventListener('click', () => messagePopup.classList.add('hidden'));

        // --- Logika Otentikasi & Routing ---
        // **NEW** Fungsi untuk membuat dokumen pengguna dan mendengarkan statusnya
        async function setupUserAndListener(userId) {
            const userDocRef = doc(db, "users", userId);
            
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isPremiumUser = data.isPremium === true;
                    hasHadFreeSuccess = data.hasHadFreeSuccess === true;
                } else {
                    // Jika dokumen belum ada, buat untuk pengguna baru
                    setDoc(userDocRef, {
                        isPremium: false,
                        hasHadFreeSuccess: false,
                        createdAt: new Date()
                    }).catch(e => console.error("Gagal membuat dokumen pengguna:", e));
                }
            });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                if (!user.isAnonymous) {
                    // Admin Logged In
                    appContainer.classList.add('hidden');
                    adminLoginSection.classList.add('hidden');
                    adminCmsSection.classList.remove('hidden');
                    initCms();
                } else {
                    // Anonymous User
                    appContainer.classList.remove('hidden');
                    adminLoginSection.classList.add('hidden');
                    adminCmsSection.classList.add('hidden');
                    // **NEW** Panggil fungsi listener untuk pengguna anonim
                    setupUserAndListener(user.uid);
                }
            } else {
                currentUser = null;
                const isAdminUrl = window.location.hash === '#admin';
                appContainer.classList.toggle('hidden', isAdminUrl);
                adminLoginSection.classList.toggle('hidden', !isAdminUrl);
                adminCmsSection.classList.add('hidden');
                if (!isAdminUrl) {
                    signInAnonymously(auth).catch(error => console.error("Gagal login anonim:", error));
                }
            }
        });

        window.addEventListener('hashchange', () => location.reload());
        
        // --- Logika Admin (CMS) ---
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => showMessage('Login Gagal', error.message));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        async function initCms() {
            if (ramalanNumberSelect.options.length > 1) return;
            for (let i = 1; i <= 100; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Nomor ${i}`;
                ramalanNumberSelect.appendChild(option);
            }
            loadRamalanData(1);
        }

        ramalanNumberSelect.addEventListener('change', (e) => loadRamalanData(e.target.value));

        async function loadRamalanData(number) {
            try {
                const docRef = doc(db, "ramalan", String(number));
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    sinthioInput.value = data.sinthio || '';
                    syairInput.value = data.syair || '';
                    selayangPandangInput.value = data.selayangPandang || '';
                    pedomanInput.value = (data.pedoman || []).join('\n');
                } else {
                    sinthioInput.value = '';
                    syairInput.value = '';
                    selayangPandangInput.value = '';
                    pedomanInput.value = '';
                }
            } catch (error) {
                showMessage('Error', 'Gagal memuat data ramalan.');
            }
        }

        saveBtn.addEventListener('click', async () => {
            const number = ramalanNumberSelect.value;
            const dataToSave = {
                nomor: parseInt(number),
                sinthio: sinthioInput.value,
                syair: syairInput.value,
                selayangPandang: selayangPandangInput.value,
                pedoman: pedomanInput.value.split('\n').filter(line => line.trim() !== '')
            };
            try {
                await setDoc(doc(db, "ramalan", number), dataToSave);
                showMessage('Sukses', `Data untuk nomor ${number} berhasil disimpan.`);
            } catch (error) {
                showMessage('Error', 'Gagal menyimpan data.');
            }
        });

        // --- Logika Aplikasi Pengguna ---
        function resetState() {
            throwCount = 0;
            throwCountElement.textContent = throwCount;
            throwBtn.disabled = true;
            shakeBtn.disabled = false; // Aktifkan kembali tombol kocok
            shakeResult.classList.add('hidden');
            throwResult.classList.add('hidden');
            predictionResult.classList.add('hidden');
            puakpois.forEach(p => p.textContent = '-');
            currentPredictionNumberState = null;
        }

        nameInput.addEventListener('input', () => {
            shakeBtn.disabled = nameInput.value.trim() === '';
        });

        shakeBtn.addEventListener('click', () => {
            resetState();
            ciamsiContainer.classList.add('shake-animation');
            fallingStick.classList.remove('fall-animation');
            fallingStick.style.opacity = 0;

            setTimeout(() => {
                ciamsiContainer.classList.remove('shake-animation');
                fallingStick.classList.add('fall-animation');
                
                const randomNumber = Math.floor(Math.random() * 100) + 1;
                predictionNumber.textContent = randomNumber;
                currentPredictionNumberState = randomNumber;
                
                shakeResult.classList.remove('hidden');
                throwBtn.disabled = false;
            }, 800);
        });

        throwBtn.addEventListener('click', async () => {
            // **NEW** Logika untuk memberikan satu kali kesempatan berhasil
            if (!hasHadFreeSuccess) {
                console.log("Memberikan satu kali kesempatan berhasil gratis.");
                puakpois.forEach(poi => {
                    poi.textContent = '';
                    poi.classList.add('throw-animation');
                    setTimeout(() => poi.classList.remove('throw-animation'), 800);
                });

                setTimeout(async () => {
                    puakpois[0].textContent = '凹';
                    puakpois[1].textContent = '凸';
                    throwResultText.textContent = 'Hasil: Direstui Dewa! (Kesempatan Pertama)';
                    throwResult.classList.remove('hidden');
                    showPrediction();
                    throwBtn.disabled = true;
                    showMessage('Kesempatan Gratis Digunakan', 'Anda telah menggunakan kesempatan gratis Anda. Untuk ramalan berikutnya, silakan kocok tabung kembali.');
                    
                    if (currentUser) {
                        const userDocRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userDocRef, { hasHadFreeSuccess: true });
                    }
                }, 900);
                return; // Hentikan eksekusi lebih lanjut
            }

            // Logika lama untuk pengguna yang sudah menggunakan kesempatan gratis
            if (!isPremiumUser && throwCount >= maxThrowsFree) {
                showMessage('Batas Tercapai', 'Anda telah mencapai batas 3x lemparan untuk sesi ini.');
                paymentPopup.classList.remove('hidden');
                return;
            }

            throwCount++;
            throwCountElement.textContent = throwCount;
            
            puakpois.forEach(poi => {
                poi.textContent = '';
                poi.classList.add('throw-animation');
                setTimeout(() => poi.classList.remove('throw-animation'), 800);
            });
            
            try {
                const counterRef = doc(db, "counters", "main");
                const counterSnap = await getDoc(counterRef);
                noBlessingCounter = counterSnap.exists() ? counterSnap.data().noBlessingCount : 0;
            } catch (e) {
                noBlessingCounter = 0;
            }

            setTimeout(async () => {
                let isConfirmed = false;
                let forceNoBlessing = (noBlessingCounter >= 2 && Math.random() < 0.3);

                if (forceNoBlessing) {
                    isConfirmed = false;
                } else {
                    const result1 = Math.round(Math.random());
                    const result2 = Math.round(Math.random());
                    puakpois[0].textContent = result1 === 0 ? '凹' : '凸';
                    puakpois[1].textContent = result2 === 0 ? '凹' : '凸';
                    isConfirmed = result1 !== result2;
                }
                
                if (isConfirmed) {
                    throwResultText.textContent = 'Hasil: Direstui Dewa!';
                    throwResult.classList.remove('hidden');
                    showPrediction();
                    throwBtn.disabled = true;
                } else {
                    try {
                       const counterRef = doc(db, "counters", "main");
                       await updateDoc(counterRef, { noBlessingCount: increment(1) });
                    } catch(e) {
                       if (e.code === 'not-found') {
                           await setDoc(doc(db, "counters", "main"), { noBlessingCount: 1 });
                       }
                    }

                    if (forceNoBlessing) {
                        throwResultText.textContent = 'Dewa belum memberi restu. Silakan coba lagi.';
                        paymentPopup.classList.remove('hidden');
                    } else if (!isPremiumUser && throwCount >= maxThrowsFree) {
                        throwResultText.textContent = 'Batas lemparan tercapai. Ramalan tetap ditampilkan.';
                        showPrediction();
                        throwBtn.disabled = true;
                    } else {
                        throwResultText.textContent = 'Hasil: Belum direstui. Coba lempar lagi.';
                    }
                    throwResult.classList.remove('hidden');
                }
            }, 900);
        });

        async function showPrediction() {
            if (!currentPredictionNumberState) return;
            try {
                const docRef = doc(db, "ramalan", String(currentPredictionNumberState));
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    resultNumber.textContent = data.nomor;
                    sinthioText.textContent = data.sinthio || 'Tidak ada data.';
                    syairText.textContent = data.syair || 'Tidak ada data.';
                    selayangPandangText.textContent = data.selayangPandang || 'Tidak ada data.';
                    pedomanList.innerHTML = '';
                    if (data.pedoman && data.pedoman.length > 0) {
                        data.pedoman.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            pedomanList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'Tidak ada data.';
                        pedomanList.appendChild(li);
                    }
                    predictionResult.classList.remove('hidden');
                    predictionResult.scrollIntoView({ behavior: 'smooth' });
                    setupShareAndDownload(data);
                } else {
                    showMessage('Error', 'Data ramalan untuk nomor ini tidak ditemukan.');
                }
            } catch (error) {
                showMessage('Error', 'Gagal memuat data ramalan dari server.');
            }
        }
        
        function setupShareAndDownload(data) {
            const shareText = `*Ramalan Ciam Si untuk ${nameInput.value.trim()}*\n` +
                `*Nomor: ${data.nomor}*\n\n` +
                `*Makna Lambang:*\n${data.sinthio}\n\n` +
                `*Bunyi Syair:*\n${data.syair}\n\n` +
                `Dapatkan ramalan Anda di: ${window.location.href.split('#')[0]}`;
            
            document.getElementById('whatsappShare').href = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
            
            document.getElementById('downloadBtn').onclick = () => {
                html2canvas(document.getElementById('predictionCard'), {
                    backgroundColor: '#f8f4e9', scale: 2
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Ramalan_CiamSi_${nameInput.value.trim().replace(/\s/g, '_')}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                });
            };
        }
        
        closePopupBtn.addEventListener('click', () => paymentPopup.classList.add('hidden'));
        document.getElementById('upgradeBtn').addEventListener('click', () => {
           showMessage('Informasi', 'Fitur upgrade akan segera tersedia. Terima kasih atas minat Anda!');
           paymentPopup.classList.add('hidden');
        });

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered.', reg))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    </script>
</body>
</html>

