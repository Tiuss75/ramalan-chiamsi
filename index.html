<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ramalan Chiamsi</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root { --primary:#b80d1c; --bg:#111; --card:#1a1a1a; --muted:#777; --text:#f3f3f3; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:960px;margin:0 auto;padding:20px}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:28px}
    p.muted{margin:0 0 18px;color:var(--muted)}
    .row{display:grid;gap:16px}
    @media(min-width:800px){.row{grid-template-columns:1.2fr .8fr}}
    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#bbb}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#fff}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;background:#262626;color:#fff}
    button.primary{background:var(--primary)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .pkg{border:1px solid #2a2a2a;border-radius:14px;padding:14px;cursor:pointer;transition:.2s}
    .pkg:hover{border-color:#444;transform:translateY(-1px)}
    .hidden{display:none}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#2a2a2a;color:#ddd;font-size:12px}
    .result-card{background:#121212;border:1px solid #2a2a2a;border-radius:14px;padding:14px}/* Popup */
.popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
.popup-content{background:#191919;border:1px solid #2b2b2b;border-radius:16px;padding:18px;width:100%;max-width:420px}
.popup-content h2{margin:0 0 6px}
.popup-buttons{display:flex;gap:10px;flex-wrap:wrap}
.form-group{margin:10px 0}

/* Simple animations */
.shake-animation{animation:shake .8s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}}
.fall-animation{animation:fall .9s forwards}
@keyframes fall{0%{opacity:0;transform:translateY(-20px)}100%{opacity:1;transform:translateY(0)}}
.throw-animation{animation:bounce .8s}
@keyframes bounce{0%{transform:translateY(-6px)}100%{transform:translateY(0)}}

  </style>
  <!-- Midtrans Snap.js (SANDBOX). Ganti client-key bila perlu -->
  <script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-hCnSsq93YoH_kxLO"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Ramalan Chiamsi</h1>
      <p class="muted">2x percobaan gratis tanpa login. Untuk lanjut & simpan status premium, masuk dengan email.</p><div class="row">
    <!-- Left: Game -->
    <div>
      <div class="stack">
        <div style="flex:1">
          <label for="nameInput">Nama</label>
          <input id="nameInput" placeholder="Nama kamu" />
        </div>
        <button id="shakeBtn" class="primary" disabled>Kocok Chiamsi</button>
      </div>

      <div id="shakeResult" class="result-card hidden" style="margin-top:12px">
        <div>Nomor Chiamsi: <strong id="predictionNumber">-</strong></div>
        <div class="stack" style="margin-top:10px">
          <button id="throwBtn">Lempar Puakpoi</button>
          <span class="badge">Lempar: <span id="throwCount">0</span>/3</span>
        </div>
      </div>

      <div id="throwResult" class="result-card hidden" style="margin-top:10px">
        <div class="stack">
          <div>Puakpoi 1: <strong id="puakpoi1">-</strong></div>
          <div>Puakpoi 2: <strong id="puakpoi2">-</strong></div>
        </div>
        <div id="throwResultText" style="margin-top:6px">-</div>
      </div>

      <div id="predictionResult" class="result-card hidden" style="margin-top:10px">
        <div>Nomor: <strong id="resultNumber">-</strong></div>
        <div style="margin-top:6px">
          <div><strong>Sinthio</strong></div>
          <div id="sinthioText">-</div>
        </div>
        <div style="margin-top:6px">
          <div><strong>Syair</strong></div>
          <div id="syairText">-</div>
        </div>
        <div style="margin-top:6px">
          <div><strong>Selayang Pandang</strong></div>
          <div id="selayangPandangText">-</div>
        </div>
        <div style="margin-top:6px">
          <div><strong>Pedoman</strong></div>
          <ul id="pedomanList" style="margin:6px 0 0 18px"></ul>
        </div>
      </div>
    </div>

    <!-- Right: Paket & Status -->
    <div>
      <div class="result-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Paket Kocok</strong>
          <button id="goToPayment" class="primary">Upgrade</button>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="pkg package-option" data-attempts="5" data-price="25000">
            <div><strong>5x Kocok</strong></div>
            <div class="muted">Rp 25.000</div>
          </div>
          <div class="pkg package-option" data-attempts="12" data-price="50000">
            <div><strong>12x Kocok</strong></div>
            <div class="muted">Rp 50.000</div>
          </div>
          <div class="pkg" id="testModeBtn">
            <div><strong>Mode Uji</strong></div>
            <div class="muted">Gratis premium (dev)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

  </div>  <!-- Popup: Payment pilih paket (sudah ada tombol Upgrade juga) -->  <div id="paymentPopup" class="popup-overlay hidden">
    <div class="popup-content">
      <h2>Pilih Paket</h2>
      <p class="muted">Silakan pilih paket untuk menambah kesempatan kocok.</p>
      <div class="grid">
        <button class="pkg package-option" data-attempts="5" data-price="25000">5x – Rp 25.000</button>
        <button class="pkg package-option" data-attempts="12" data-price="50000">12x – Rp 50.000</button>
        <button class="pkg" id="testModeBtn2">Mode Uji (Premium)</button>
      </div>
      <div class="popup-buttons" style="margin-top:10px">
        <button id="closePaymentPopup">Tutup</button>
      </div>
    </div>
  </div>  <!-- Popup: Konfirmasi sebelum Snap -->  <div id="confirmPaymentPopup" class="popup-overlay hidden">
    <div class="popup-content">
      <h2>Konfirmasi Pembayaran</h2>
      <p>Anda akan membeli paket <strong><span id="attemptsDisplay">-</span>x</strong> seharga <strong>Rp <span id="priceDisplay">-</span></strong>.</p>
      <div class="popup-buttons">
        <button id="confirmRealPayment" class="primary">Lanjut ke Midtrans</button>
        <button id="cancelConfirm">Batal</button>
      </div>
    </div>
  </div>  <!-- Popup: Pesan umum -->  <div id="messagePopup" class="popup-overlay hidden">
    <div class="popup-content">
      <h2 id="messageTitle">Info</h2>
      <p id="messageText">-</p>
      <div class="popup-buttons">
        <button id="closeMessageBtn" class="primary">OK</button>
      </div>
    </div>
  </div>  <!-- Popup Login User (email/password) -->  <div id="userAuthPopup" class="popup-overlay hidden">
    <div class="popup-content" style="max-width:520px">
      <h2>Masuk untuk Lanjut</h2>
      <p class="muted">Buat akun atau masuk agar status premium & kuota tersimpan.</p>
      <div class="form-group">
        <label for="userEmail">Email</label>
        <input id="userEmail" type="email" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label for="userPassword">Password</label>
        <input id="userPassword" type="password" placeholder="••••••••" />
      </div>
      <div class="popup-buttons" style="margin-top:10px">
        <button id="userRegisterBtn" class="primary">Daftar & Lanjut</button>
        <button id="userLoginBtn">Masuk</button>
        <button id="userAuthCloseBtn">Batal</button>
      </div>
    </div>
  </div>  <!-- Firebase App -->  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, browserLocalPersistence, setPersistence, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzYog6EbRLen7pg2aITsf5utEXQUVP3n0",
      authDomain: "ramalan-chiamsi-df5b0.firebaseapp.com",
      projectId: "ramalan-chiamsi-df5b0",
      storageBucket: "ramalan-chiamsi-df5b0.appspot.com",
      messagingSenderId: "152505108899",
      appId: "1:152505108899:web:b1e2e90ac2d7e722997216"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    const createTransaction = httpsCallable(functions, 'createMidtransTransaction');

    // ==== DOM ====
    const nameInput = document.getElementById('nameInput');
    const shakeBtn = document.getElementById('shakeBtn');
    const throwBtn = document.getElementById('throwBtn');
    const shakeResult = document.getElementById('shakeResult');
    const predictionNumber = document.getElementById('predictionNumber');
    const throwResult = document.getElementById('throwResult');
    const throwResultText = document.getElementById('throwResultText');
    const predictionResult = document.getElementById('predictionResult');
    const puakpoi1 = document.getElementById('puakpoi1');
    const puakpoi2 = document.getElementById('puakpoi2');
    const throwCountElement = document.getElementById('throwCount');
    const resultNumber = document.getElementById('resultNumber');
    const sinthioText = document.getElementById('sinthioText');
    const syairText = document.getElementById('syairText');
    const selayangPandangText = document.getElementById('selayangPandangText');
    const pedomanList = document.getElementById('pedomanList');
    const paymentPopup = document.getElementById('paymentPopup');
    const confirmPaymentPopup = document.getElementById('confirmPaymentPopup');
    const closePaymentPopup = document.getElementById('closePaymentPopup');
    const confirmRealPayment = document.getElementById('confirmRealPayment');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const goToPaymentBtn = document.getElementById('goToPayment');
    const priceDisplay = document.getElementById('priceDisplay');
    const attemptsDisplay = document.getElementById('attemptsDisplay');
    const testModeBtn2 = document.getElementById('testModeBtn2');

    // Popup Login User
    const userAuthPopup = document.getElementById('userAuthPopup');
    const userEmail = document.getElementById('userEmail');
    const userPassword = document.getElementById('userPassword');
    const userRegisterBtn = document.getElementById('userRegisterBtn');
    const userLoginBtn = document.getElementById('userLoginBtn');
    const userAuthCloseBtn = document.getElementById('userAuthCloseBtn');

    // Message popup
    const messagePopup = document.getElementById('messagePopup');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const closeMessageBtn = document.getElementById('closeMessageBtn');
    function showMessage(title, text){ messageTitle.textContent=title; messageText.textContent=text; messagePopup.classList.remove('hidden'); }
    closeMessageBtn.addEventListener('click',()=>messagePopup.classList.add('hidden'));

    // ==== State ====
    let currentUser = null;
    let selectedPackage = null;
    let unsubscribeUserListener = null;
    let isPremiumUser = false;
    let freeAttemptsLeft = 2;
    const maxThrowsFree = 3;
    let currentPredictionNumberState = null;
    let throwCount = 0;

    // ==== Auth persistence + anon flow ====
    await setPersistence(auth, browserLocalPersistence);

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if (!user){ await signInAnonymously(auth); return; }
      await setupUserDocAndListener(user.uid);
      // enable name field logic
      shakeBtn.disabled = (nameInput.value.trim()==='') || (freeAttemptsLeft<=0 && !isPremiumUser);
    });

    async function setupUserDocAndListener(uid){
      if (unsubscribeUserListener) unsubscribeUserListener();
      const userDocRef = doc(db,'users',uid);
      const snap = await getDoc(userDocRef);
      if (!snap.exists()){
        await setDoc(userDocRef,{ isPremium:false, freeAttemptsLeft:2, createdAt:serverTimestamp() });
      }
      unsubscribeUserListener = onSnapshot(userDocRef,(d)=>{
        if (!d.exists()) return;
        const data = d.data();
        isPremiumUser = !!data.isPremium;
        freeAttemptsLeft = typeof data.freeAttemptsLeft==='number' ? data.freeAttemptsLeft : 0;
        if (freeAttemptsLeft<=0 && !isPremiumUser){ shakeBtn.disabled = true; }
      });
    }

    // ==== Game logic (ringkas) ====
    function resetState(){
      if (isPremiumUser || freeAttemptsLeft>0){
        throwCount = 0; throwCountElement.textContent = throwCount;
        throwBtn.disabled = true;
        shakeResult.classList.add('hidden');
        throwResult.classList.add('hidden');
        predictionResult.classList.add('hidden');
        puakpoi1.textContent='-'; puakpoi2.textContent='-';
        currentPredictionNumberState = null;
        shakeBtn.disabled = (nameInput.value.trim()==='');
      } else {
        showMessage('Akses Dibatasi','Kesempatan uji coba habis. Silakan upgrade.');
      }
    }

    nameInput.addEventListener('input',()=>{
      if (predictionResult.classList.contains('hidden')){
        shakeBtn.disabled = nameInput.value.trim()==='' || (freeAttemptsLeft<=0 && !isPremiumUser);
      }
    });

    shakeBtn.addEventListener('click',()=>{
      if (freeAttemptsLeft<=0 && !isPremiumUser){ paymentPopup.classList.remove('hidden'); return; }
      resetState();
      const container = document.querySelector('.card');
      container.classList.add('shake-animation');
      setTimeout(()=>{
        container.classList.remove('shake-animation');
        const randomNumber = Math.floor(Math.random()*100)+1;
        predictionNumber.textContent = randomNumber;
        currentPredictionNumberState = randomNumber;
        shakeResult.classList.remove('hidden');
        throwBtn.disabled = false;
      },800);
    });

    throwBtn.addEventListener('click', async ()=>{
      throwBtn.disabled = true; throwCount++; throwCountElement.textContent = throwCount;
      puakpoi1.classList.add('throw-animation'); puakpoi2.classList.add('throw-animation');
      setTimeout(async ()=>{
        const confirmed = Math.random() > 0.5;
        puakpoi1.textContent = confirmed ? '凹' : '凸';
        puakpoi2.textContent = confirmed ? '凸' : '凹';
        if (confirmed){ await showPrediction(); }
        else {
          if (!isPremiumUser && throwCount>=maxThrowsFree){
            paymentPopup.classList.remove('hidden');
            throwResultText.textContent = 'Batas lemparan tercapai.';
          } else {
            throwResultText.textContent = 'Belum direstui. Coba lagi.';
            throwBtn.disabled = false;
          }
          throwResult.classList.remove('hidden');
        }
        puakpoi1.classList.remove('throw-animation'); puakpoi2.classList.remove('throw-animation');
      },850);
    });

    async function showPrediction(){
      if (!currentPredictionNumberState) return;
      const docRef = doc(db,'ramalan',String(currentPredictionNumberState));
      const snap = await getDoc(docRef);
      if (snap.exists()){
        const data = snap.data();
        resultNumber.textContent = data.nomor || currentPredictionNumberState;
        sinthioText.textContent = data.sinthio || 'Data belum diisi.';
        syairText.textContent = data.syair || 'Data belum diisi.';
        selayangPandangText.textContent = data.selayangPandang || 'Data belum diisi.';
        pedomanList.innerHTML='';
        (data.pedoman||[]).forEach(it=>{ const li=document.createElement('li'); li.textContent=it; pedomanList.appendChild(li); });
        predictionResult.classList.remove('hidden');
        shakeBtn.disabled = true;
        if (!isPremiumUser){
          const userDocRef = doc(db,'users',currentUser.uid);
          await updateDoc(userDocRef,{ freeAttemptsLeft: increment(-1) });
          freeAttemptsLeft -= 1;
          if (freeAttemptsLeft<=0){ setTimeout(()=>paymentPopup.classList.remove('hidden'),1200); }
          else { shakeBtn.disabled = false; }
        }
      } else {
        showMessage('Data Kosong',`Data ramalan nomor ${currentPredictionNumberState} belum diisi.`);
        predictionResult.classList.add('hidden');
        shakeBtn.disabled = false;
      }
    }

    // ===== Upgrade / Pembayaran =====
    function openPaymentOrLogin(){
      if (!auth.currentUser || auth.currentUser.isAnonymous){ userAuthPopup.classList.remove('hidden'); }
      else { paymentPopup.classList.remove('hidden'); }
    }
    document.getElementById('testModeBtn').addEventListener('click',()=>activateTestMode());
    testModeBtn2.addEventListener('click',()=>activateTestMode());
    goToPaymentBtn.addEventListener('click',openPaymentOrLogin);

    document.querySelectorAll('.package-option').forEach(pkg=>{
      pkg.addEventListener('click',()=>{
        if (pkg.id==='testModeBtn' || pkg.id==='testModeBtn2'){ activateTestMode(); return; }
        selectedPackage = { attempts: parseInt(pkg.getAttribute('data-attempts')), price: parseInt(pkg.getAttribute('data-price')) };
        priceDisplay.textContent = selectedPackage.price.toLocaleString();
        attemptsDisplay.textContent = selectedPackage.attempts;
        confirmPaymentPopup.classList.remove('hidden');
        paymentPopup.classList.add('hidden');
      });
    });

    confirmRealPayment.addEventListener('click', async ()=>{
      if (!auth.currentUser || auth.currentUser.isAnonymous){
        confirmPaymentPopup.classList.add('hidden');
        userAuthPopup.classList.remove('hidden');
        return;
      }
      const btn = confirmRealPayment; btn.disabled = true; btn.textContent = 'Memproses...';
      try {
        const result = await createTransaction({ name: nameInput.value.trim()||'Pengguna', price: selectedPackage.price, attempts: selectedPackage.attempts });
        const token = result.data.token;
        window.snap.pay(token, {
          onSuccess: async ()=>{ showMessage('Sukses',`Pembayaran berhasil! +${selectedPackage.attempts} kali kocok.`); await addAttempts(selectedPackage.attempts); confirmPaymentPopup.classList.add('hidden'); },
          onPending: ()=>{ showMessage('Pending','Menunggu konfirmasi pembayaran.'); confirmPaymentPopup.classList.add('hidden'); },
          onError: (err)=>{ console.error(err); showMessage('Gagal','Pembayaran gagal. Coba lagi.'); },
          onClose: ()=>{}
        });
      } catch(e){ console.error(e); showMessage('Error','Gagal memproses pembayaran.'); }
      finally{ btn.disabled=false; btn.textContent='Lanjut ke Midtrans'; }
    });

    async function addAttempts(count){
      if (!auth.currentUser) return;
      const userDocRef = doc(db,'users',auth.currentUser.uid);
      await updateDoc(userDocRef,{ freeAttemptsLeft: increment(count), isPremium:true });
    }

    function activateTestMode(){ showMessage('Mode Uji','🎉 Premium aktif (dev)'); addAttempts(12); paymentPopup.classList.add('hidden'); }

    // Close popups
    document.getElementById('closePaymentPopup').addEventListener('click',()=>paymentPopup.classList.add('hidden'));
    cancelConfirm.addEventListener('click',()=>{ confirmPaymentPopup.classList.add('hidden'); paymentPopup.classList.remove('hidden'); });

    // ===== Popup Login User =====
    userAuthCloseBtn.addEventListener('click',()=>userAuthPopup.classList.add('hidden'));

    userRegisterBtn.addEventListener('click', async ()=>{
      const email=(userEmail.value||'').trim(); const pass=(userPassword.value||'').trim();
      if(!email||!pass){ showMessage('Error','Email & password wajib diisi.'); return; }
      try{
        if (auth.currentUser && auth.currentUser.isAnonymous){
          const cred = EmailAuthProvider.credential(email,pass);
          await linkWithCredential(auth.currentUser,cred);
        } else {
          await createUserWithEmailAndPassword(auth,email,pass);
        }
        userAuthPopup.classList.add('hidden');
        paymentPopup.classList.remove('hidden');
      }catch(e){ showMessage('Gagal Daftar', e.message); }
    });

    userLoginBtn.addEventListener('click', async ()=>{
      const email=(userEmail.value||'').trim(); const pass=(userPassword.value||'').trim();
      if(!email||!pass){ showMessage('Error','Email & password wajib diisi.'); return; }
      try{
        if (auth.currentUser && auth.currentUser.isAnonymous){
          try{ const cred = EmailAuthProvider.credential(email,pass); await linkWithCredential(auth.currentUser,cred); }
          catch{ await signInWithEmailAndPassword(auth,email,pass); }
        } else {
          await signInWithEmailAndPassword(auth,email,pass);
        }
        userAuthPopup.classList.add('hidden');
        paymentPopup.classList.remove('hidden');
      }catch(e){ showMessage('Gagal Masuk', e.message); }
    });
  </script></body>
</html>