<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramalan Chiam Si</title>
    <meta name="theme-color" content="#9c1c26">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="favicon-512.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript"
        src="https://app.midtrans.com/snap/snap.js" 
        data-client-key="SB-Mid-client-hCnSsq93YoH_kXLO"></script>
    <style>
        /* CSS yang sama seperti sebelumnya */
        /* ... (tetap gunakan CSS yang Anda miliki) ... */
        
        /* Tambahan untuk form login/register */
        .auth-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: rgba(44,36,22,.85);
            border-radius: 15px;
            border: 2px solid var(--gold);
        }
        .auth-form h2 {
            text-align: center;
            color: var(--gold);
            margin-bottom: 20px;
        }
        .auth-form input {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid var(--dark-gold);
            background: var(--light-gold);
            color: var(--black);
        }
        .auth-form button {
            width: 100%;
            margin-top: 15px;
        }
        .auth-switch {
            text-align: center;
            margin-top: 15px;
            color: var(--light-gold);
        }
        .auth-switch a {
            color: var(--gold);
            cursor: pointer;
            text-decoration: underline;
        }
        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Main App Container (default hidden) -->
    <div id="appContainer" class="container hidden">
        <div class="user-menu">
            <span id="userEmailDisplay" style="color: var(--gold);"></span>
            <button id="logoutBtn" class="btn" style="padding: 8px 15px;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        
        <!-- Konten aplikasi utama -->
        <!-- ... (tetap gunakan konten yang sama) ... -->
    </div>

    <!-- Admin CMS Section (default hidden) -->
    <div id="adminCmsSection" class="container hidden">
        <h2>CMS Ramalan Chiam Si <button id="adminLogoutBtn" class="btn" style="float: right;">Logout</button></h2>
        <!-- ... (konten CMS admin yang sama) ... -->
    </div>

    <!-- Auth Forms -->
    <div id="authContainer">
        <!-- Form Login User -->
        <div id="userLoginForm" class="auth-form">
            <h2>Login Pengguna</h2>
            <div id="loginError" style="color: #ff6b6b; margin-bottom: 15px;"></div>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Password">
            <button id="userLoginBtn" class="btn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <button id="googleLoginBtn" class="btn" style="background-color: #4285F4; color: white;">
                <i class="fab fa-google"></i> Login dengan Google
            </button>
            <div class="auth-switch">Belum punya akun? <a id="showRegister">Daftar disini</a></div>
        </div>

        <!-- Form Register User -->
        <div id="userRegisterForm" class="auth-form hidden">
            <h2>Daftar Akun Baru</h2>
            <div id="registerError" style="color: #ff6b6b; margin-bottom: 15px;"></div>
            <input type="text" id="registerName" placeholder="Nama Lengkap">
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Password (min. 6 karakter)">
            <button id="userRegisterBtn" class="btn"><i class="fas fa-user-plus"></i> Daftar</button>
            <div class="auth-switch">Sudah punya akun? <a id="showLogin">Login disini</a></div>
        </div>

        <!-- Form Login Admin -->
        <div id="adminLoginForm" class="auth-form hidden">
            <h2>Login Admin</h2>
            <div id="adminLoginError" style="color: #ff6b6b; margin-bottom: 15px;"></div>
            <input type="email" id="adminEmail" placeholder="Email Admin">
            <input type="password" id="adminPassword" placeholder="Password">
            <button id="adminLoginBtn" class="btn"><i class="fas fa-lock"></i> Login Admin</button>
            <div class="auth-switch">Login sebagai <a id="showUserLogin">pengguna biasa</a></div>
        </div>
    </div>

    <!-- Popup dan komponen lainnya -->
    <!-- ... (tetap gunakan popup yang sama) ... -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            serverTimestamp,
            increment 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA93UxOEya10fRfOPpbOT4PfSmA_aaQx-E",
            authDomain: "siamsi-3dd65.firebaseapp.com",
            projectId: "siamsi-3dd65",
            storageBucket: "siamsi-3dd65.appspot.com",
            messagingSenderId: "675720995739",
            appId: "1:675720995739:web:1af5223781df968289373e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const createTransaction = httpsCallable(functions, 'createMidtransTransaction');

        // === DOM Elements ===
        const appContainer = document.getElementById('appContainer');
        const authContainer = document.getElementById('authContainer');
        const adminCmsSection = document.getElementById('adminCmsSection');
        const userLoginForm = document.getElementById('userLoginForm');
        const userRegisterForm = document.getElementById('userRegisterForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const registerName = document.getElementById('registerName');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const userRegisterBtn = document.getElementById('userRegisterBtn');
        const adminEmail = document.getElementById('adminEmail');
        const adminPassword = document.getElementById('adminPassword');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const showUserLogin = document.getElementById('showUserLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const userEmailDisplay = document.getElementById('userEmailDisplay');

        // === App State ===
        let currentUser = null;
        let isUserAdmin = false;
        let unsubscribeUserListener = null;

        // === Auth Functions ===
        async function handleUserLogin(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await setupUserAndListener(userCredential.user);
                showAppContent();
            } catch (error) {
                document.getElementById('loginError').textContent = getAuthErrorMessage(error.code);
                console.error("Login error:", error);
            }
        }

        async function handleAdminLogin(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const adminDoc = await getDoc(doc(db, "admins", userCredential.user.uid));
                
                if (!adminDoc.exists()) {
                    await auth.signOut();
                    throw new Error("Anda bukan admin yang terdaftar");
                }
                
                isUserAdmin = true;
                showAdminCMS();
            } catch (error) {
                document.getElementById('adminLoginError').textContent = getAuthErrorMessage(error.code);
                console.error("Admin login error:", error);
            }
        }

        async function handleUserRegister(name, email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Simpan data user tambahan
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    name: name,
                    email: email,
                    isPremium: false,
                    freeAttemptsLeft: 2,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                
                await setupUserAndListener(userCredential.user);
                showAppContent();
            } catch (error) {
                document.getElementById('registerError').textContent = getAuthErrorMessage(error.code);
                console.error("Registration error:", error);
            }
        }

        async function handleGoogleLogin() {
            try {
                const provider = new GoogleAuthProvider();
                const userCredential = await signInWithPopup(auth, provider);
                
                // Cek apakah user sudah terdaftar sebelumnya
                const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                
                if (!userDoc.exists()) {
                    // Simpan data user baru
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        name: userCredential.user.displayName,
                        email: userCredential.user.email,
                        isPremium: false,
                        freeAttemptsLeft: 2,
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp(),
                        photoURL: userCredential.user.photoURL
                    });
                }
                
                await setupUserAndListener(userCredential.user);
                showAppContent();
            } catch (error) {
                document.getElementById('loginError').textContent = getAuthErrorMessage(error.code);
                console.error("Google login error:", error);
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch(errorCode) {
                case 'auth/invalid-email': return 'Email tidak valid';
                case 'auth/user-disabled': return 'Akun dinonaktifkan';
                case 'auth/user-not-found': return 'Akun tidak ditemukan';
                case 'auth/wrong-password': return 'Password salah';
                case 'auth/email-already-in-use': return 'Email sudah terdaftar';
                case 'auth/weak-password': return 'Password terlalu lemah (min. 6 karakter)';
                case 'auth/operation-not-allowed': return 'Operasi tidak diizinkan';
                case 'auth/too-many-requests': return 'Terlalu banyak percobaan gagal. Coba lagi nanti';
                default: return 'Terjadi kesalahan. Silakan coba lagi';
            }
        }

        // === UI Functions ===
        function showLoginForm() {
            userLoginForm.classList.remove('hidden');
            userRegisterForm.classList.add('hidden');
            adminLoginForm.classList.add('hidden');
        }

        function showRegisterForm() {
            userLoginForm.classList.add('hidden');
            userRegisterForm.classList.remove('hidden');
            adminLoginForm.classList.add('hidden');
        }

        function showAdminLoginForm() {
            userLoginForm.classList.add('hidden');
            userRegisterForm.classList.add('hidden');
            adminLoginForm.classList.remove('hidden');
        }

        function showAppContent() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            adminCmsSection.classList.add('hidden');
        }

        function showAdminCMS() {
            authContainer.classList.add('hidden');
            appContainer.classList.add('hidden');
            adminCmsSection.classList.remove('hidden');
        }

        function showAuthForms() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            adminCmsSection.classList.add('hidden');
            showLoginForm();
        }

        // === User Management ===
        async function setupUserAndListener(user) {
            if (unsubscribeUserListener) unsubscribeUserListener();
            
            currentUser = user;
            userEmailDisplay.textContent = user.email || 'Pengguna';
            
            // Cek apakah user adalah admin
            const adminDoc = await getDoc(doc(db, "admins", user.uid));
            isUserAdmin = adminDoc.exists();
            
            if (isUserAdmin) {
                showAdminCMS();
            } else {
                showAppContent();
                
                // Setup listener untuk perubahan data user
                unsubscribeUserListener = onSnapshot(doc(db, "users", user.uid), (doc) => {
                    if (doc.exists()) {
                        const userData = doc.data();
                        updateUIBasedOnUserState(userData);
                    }
                });
            }
        }

        function updateUIBasedOnUserState(userData) {
            // Update UI berdasarkan status user (premium/free)
            const canShake = nameInput.value.trim() !== '' && 
                            (userData.isPremium || userData.freeAttemptsLeft > 0);
            shakeBtn.disabled = !canShake;
            
            // Update tampilan untuk user premium
            if (userData.isPremium) {
                document.querySelector('.menu .btn').textContent = "Akun Premium";
            }
        }

        // === Event Listeners ===
        userLoginBtn.addEventListener('click', () => {
            if (!loginEmail.value || !loginPassword.value) {
                document.getElementById('loginError').textContent = 'Email dan password harus diisi';
                return;
            }
            handleUserLogin(loginEmail.value, loginPassword.value);
        });

        adminLoginBtn.addEventListener('click', () => {
            if (!adminEmail.value || !adminPassword.value) {
                document.getElementById('adminLoginError').textContent = 'Email dan password harus diisi';
                return;
            }
            handleAdminLogin(adminEmail.value, adminPassword.value);
        });

        userRegisterBtn.addEventListener('click', () => {
            if (!registerName.value || !registerEmail.value || !registerPassword.value) {
                document.getElementById('registerError').textContent = 'Semua field harus diisi';
                return;
            }
            if (registerPassword.value.length < 6) {
                document.getElementById('registerError').textContent = 'Password minimal 6 karakter';
                return;
            }
            handleUserRegister(registerName.value, registerEmail.value, registerPassword.value);
        });

        googleLoginBtn.addEventListener('click', handleGoogleLogin);

        showRegister.addEventListener('click', showRegisterForm);
        showLogin.addEventListener('click', showLoginForm);
        showUserLogin.addEventListener('click', showLoginForm);

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                showAuthForms();
            });
        });

        adminLogoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                showAuthForms();
            });
        });

        // === Initialize App ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                setupUserAndListener(user);
            } else {
                showAuthForms();
            }
        });

        // ... (Fungsi dan event listener lainnya tetap sama) ...
    </script>
</body>
</html>
