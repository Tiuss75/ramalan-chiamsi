<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramalan Chiam Si - PWA</title>
    <meta name="theme-color" content="#9c1c26">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" href="https://placehold.co/192x192/9c1c26/FFFFFF?text=CS" type="image/png">
    <link rel="apple-touch-icon" href="https://placehold.co/512x512/9c1c26/FFFFFF?text=CS" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript"
        src="https://app.sandbox.midtrans.com/snap/snap.js"
        data-client-key="SB-Mid-client-hCnSsq93YoH_kxLO"></script>

    <style>
        /* SEMUA GAYA CSS ADA DI SINI */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600;700&display=swap');
        :root{--primary-red:#9c1c26;--dark-red:#7a0a14;--gold:#d4af37;--light-gold:#f8ecc2;--dark-gold:#b8860b;--black:#2c2416;--white:#f8f4e9;--font-main:'Inter',sans-serif;--font-display:'Noto Serif SC',serif}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-main);background-color:var(--primary-red);background-image:linear-gradient(135deg,rgba(122,10,20,.8),rgba(28,5,7,.9));color:var(--white);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}.container{max-width:800px;width:100%;background:rgba(44,36,22,.85);border-radius:20px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.6);border:3px solid var(--gold);backdrop-filter:blur(5px)}.header{text-align:center;margin-bottom:30px}.header h1{font-family:var(--font-display);font-size:2.5rem;color:var(--gold);text-shadow:0 3px 5px rgba(0,0,0,.7); cursor: pointer; user-select: none;}.step{background:rgba(122,10,20,.6);border-radius:15px;padding:20px;margin-bottom:25px;border:2px solid var(--dark-gold)}.step-title{display:flex;align-items:center;gap:15px;margin-bottom:15px;color:var(--gold)}.step-title i{font-size:1.5rem;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background-color:var(--black);border:2px solid var(--gold)}.step-title h2{font-size:1.5rem}.name-input{width:100%;padding:12px 20px;border-radius:30px;border:2px solid var(--dark-gold);background-color:var(--light-gold);color:var(--black);font-size:1.1rem}.ciamsi-shaker-container{display:flex;justify-content:center;align-items:flex-end;height:220px;position:relative;margin:20px 0}.ciamsi-container{width:100px;height:180px;position:relative}.ciamsi-body{width:100%;height:100%;background:linear-gradient(145deg,#6d1a21,#a8323c);border-radius:15px 15px 10px 10px;border:4px solid #501015;box-shadow:inset 0 0 15px rgba(0,0,0,.5),0 10px 20px rgba(0,0,0,.4);position:absolute;bottom:0;display:flex;justify-content:center;align-items:center}.ciamsi-logo{font-family:var(--font-display);font-size:50px;color:var(--gold);text-shadow:0 0 10px rgba(212,175,55,.5)}.falling-stick{width:8px;height:130px;background:linear-gradient(#deb887,#b8860b);border:1px solid #8B4513;border-radius:5px;position:absolute;bottom:180px;opacity:0;transform-origin:bottom center}.shake-animation{animation:container-shake .8s cubic-bezier(.36,.07,.19,.97) both}@keyframes container-shake{10%,90%{transform:translate3d(-1px,0,0) rotate(-1deg)}20%,80%{transform:translate3d(2px,0,0) rotate(2deg)}30%,50%,70%{transform:translate3d(-4px,0,0) rotate(-4deg)}40%,60%{transform:translate3d(4px,0,0) rotate(4deg)}}.fall-animation{animation:stick-fall 1s forwards ease-in}@keyframes stick-fall{0%{opacity:1;transform:translateY(-180px) translateX(20px) rotate(0)}100%{opacity:1;transform:translateY(220px) translateX(70px) rotate(110deg)}}.puak-poi-container{display:flex;justify-content:center;gap:40px;margin:30px 0}.puak-poi{width:70px;height:35px;background:#d2b48c;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--black);font-weight:700;box-shadow:0 5px 15px rgba(0,0,0,.3)}.throw-animation{animation:throw .8s cubic-bezier(.36,.07,.19,.97) both}@keyframes throw{0%{transform:translateY(0) rotate(0)}30%{transform:translateY(-80px) rotate(180deg)}70%{transform:translateY(40px) rotate(360deg)}100%{transform:translateY(0) rotate(720deg)}}.btn{background:var(--gold);color:var(--black);border:none;padding:12px 25px;font-size:1.1rem;font-weight:600;border-radius:50px;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 10px rgba(0,0,0,.3);text-decoration:none}.btn:hover{background:var(--light-gold);transform:translateY(-3px)}.btn:disabled{background:#777;color:#ccc;cursor:not-allowed;transform:none;box-shadow:none}.prediction-card{background:var(--white);color:var(--black);border-radius:15px;padding:25px;margin:30px 0;border:3px solid var(--gold)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--light-gold)}.card-title{font-size:1.5rem;color:var(--primary-red);font-weight:700}.card-number{background:var(--gold);color:var(--black);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700}.prediction-section{margin-bottom:15px}.prediction-section h3{font-family:var(--font-display);color:var(--dark-red);margin-bottom:8px;border-bottom:1px solid var(--light-gold);padding-bottom:5px}.prediction-section p,.prediction-section ul{white-space:pre-wrap;line-height:1.6}.pedoman-jawaban ul{list-style:none;padding-left:0}.pedoman-jawaban li{margin-bottom:5px}.action-buttons{display:flex;justify-content:center;gap:20px;margin-top:20px}.whatsapp-share{background:#25D366;color:#fff}.whatsapp-share:hover{background:#128c7e}.download-btn{background-color:var(--dark-red);color:var(--white)}.hidden{display:none!important}.admin-section,.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;z-index:1000;padding:20px}.admin-form,.popup-content{background:var(--white);color:var(--black);padding:30px;border-radius:15px;width:100%;max-width:500px;box-shadow:0 0 20px rgba(0,0,0,.5); text-align: left;}.popup-content-legal{max-height: 80vh; overflow-y: auto;}.admin-form h2,.popup-content h2{color:var(--dark-red);margin-bottom:20px;text-align:center}.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;font-weight:600}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:1rem}.form-group textarea{min-height:100px;resize:vertical}.popup-content p{margin-bottom:20px;text-align:center;line-height:1.5}.popup-buttons{display:flex;justify-content:center;gap:15px}footer{text-align:center;color:rgba(255,255,255,.7);margin-top:30px;padding:20px;border-top:1px solid var(--dark-gold)}footer a{color:var(--light-gold);margin:0 10px;cursor:pointer}
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="appContainer" class="container">
        <div class="header"><h1>Ramalan Chiam Si</h1><p>Petunjuk ilahi untuk langkah hidup Anda</p></div>
        <div class="step"><div class="step-title"><i class="fas fa-user"></i><h2>Data Diri</h2></div><input type="text" id="nameInput" placeholder="Ketik nama Anda..." class="name-input"></div>
        <div class="step"><div class="step-title"><i class="fas fa-praying-hands"></i><h2>Kocok Tabung</h2></div><p>Fokuskan pikiran, lalu kocok tabung untuk mendapat nomor ramalan.</p><div class="ciamsi-shaker-container"><div class="ciamsi-container" id="ciamsiContainer"><div class="ciamsi-body"><div class="ciamsi-logo">簽</div></div></div><div class="falling-stick" id="fallingStick"></div></div><div style="text-align: center;"><button id="shakeBtn" class="btn" disabled><i class="fas fa-hand-point-right"></i> Kocok</button></div><div class="result-container hidden" id="shakeResult" style="text-align:center; margin-top:15px;"><p>Anda mendapatkan nomor ramalan:</p><div class="result-number" id="predictionNumber" style="font-size: 2rem; font-weight: bold; color: var(--gold);">-</div></div></div>
        <div class="step"><div class="step-title"><i class="fas fa-moon"></i><h2>Lempar Puak Poi</h2></div><p>Lemparkan Puak Poi untuk memohon restu dewa.</p><div class="puak-poi-container"><div class="puak-poi" id="puakpoi1">-</div><div class="puak-poi" id="puakpoi2">-</div></div><div class="throw-counter" style="text-align:center; margin-bottom:15px;">Lemparan ke: <span id="throwCount">0</span>/3</div><div style="text-align: center;"><button id="throwBtn" class="btn" disabled><i class="fas fa-hand-point-right"></i> Lempar</button></div><div class="result-container hidden" id="throwResult" style="text-align:center; margin-top:15px;"><p id="throwResultText">Hasil lemparan: -</p></div></div>
        <div class="hidden" id="predictionResult"><div class="prediction-card" id="predictionCard"><div class="card-header"><div class="card-title">Hasil Ramalan</div><div class="card-number" id="resultNumber">-</div></div><div class="prediction-section"><h3>Makna Lambang / Sinthio</h3><p id="sinthioText">-</p></div><div class="prediction-section"><h3>Bunyi Syair</h3><p id="syairText">-</p></div><div class="prediction-section"><h3>Selayang Pandang</h3><p id="selayangPandangText">-</p></div><div class="prediction-section pedoman-jawaban"><h3>Pedoman Jawaban</h3><ul id="pedomanList"></ul></div></div><div class="action-buttons"><a href="#" class="btn whatsapp-share" id="whatsappShare"><i class="fab fa-whatsapp"></i> Bagikan</a><button class="btn download-btn" id="downloadBtn"><i class="fas fa-download"></i> Unduh</button></div></div>
    </div>

    <!-- Admin & Popup Sections -->
    <div id="adminLoginSection" class="admin-section hidden"><div class="admin-form"><h2>Login Admin</h2><div class="form-group"><label for="adminEmail">Email</label><input type="email" id="adminEmail" placeholder="admin@email.com"></div><div class="form-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" placeholder="******"></div><button id="loginBtn" class="btn" style="width: 100%;">Login</button></div></div>
    <div id="adminCmsSection" class="container hidden" style="margin-top: 20px;"><h2>CMS Ramalan Chiam Si <button id="logoutBtn" class="btn" style="float: right;">Logout</button></h2><div class="form-group"><label for="ramalanNumberSelect">Pilih Nomor Ramalan</label><select id="ramalanNumberSelect"></select></div><div class="form-group"><label for="sinthioInput">Makna Lambang / Sinthio</label><textarea id="sinthioInput"></textarea></div><div class="form-group"><label for="syairInput">Bunyi Syair</label><textarea id="syairInput"></textarea></div><div class="form-group"><label for="selayangPandangInput">Selayang Pandang</label><textarea id="selayangPandangInput"></textarea></div><div class="form-group"><label for="pedomanInput">Pedoman Jawaban (satu per baris)</label><textarea id="pedomanInput" placeholder="PERDAGANGAN BERJALAN BIASA&#10;MENCARI HARTA BANYAK KOSONG"></textarea></div><button id="saveBtn" class="btn" style="width: 100%;">Simpan Perubahan</button></div>
    <div id="paymentPopup" class="popup-overlay hidden"><div class="popup-content"><h2>Tingkatkan Pengalaman Anda!</h2><p>Anda telah mencapai batas penggunaan gratis. Untuk melanjutkan tanpa batas, silakan tingkatkan ke paket premium.</p><div class="popup-buttons"><button id="upgradeBtn" class="btn">Upgrade Sekarang</button><button id="closePopupBtn" class="btn" style="background-color: var(--dark-red); color: var(--white);">Nanti Saja</button></div></div></div>
    <div id="messagePopup" class="popup-overlay hidden"><div class="popup-content"><h2 id="messageTitle">Pemberitahuan</h2><p id="messageText"></p><div class="popup-buttons"><button id="closeMessageBtn" class="btn">Tutup</button></div></div></div>
    <div id="termsPopup" class="popup-overlay hidden"><div class="popup-content popup-content-legal"><h2>Syarat & Ketentuan</h2><p style="text-align:left;">Selamat datang di aplikasi Ramalan Chiam Si. Dengan menggunakan aplikasi ini, Anda setuju untuk mematuhi syarat dan ketentuan berikut:</p><h4 style="text-align:left; margin-top:15px;">1. Tujuan Aplikasi</h4><p style="text-align:left;">Aplikasi ini disediakan untuk tujuan hiburan, refleksi diri, dan pelestarian budaya. Hasil yang diberikan tidak boleh dianggap sebagai nasihat profesional (keuangan, hukum, medis, dll.) dan tidak dijamin akurat 100%.</p><h4 style="text-align:left; margin-top:15px;">2. Layanan Berbayar</h4><p style="text-align:left;">Kami menawarkan akses premium berbayar untuk penggunaan tanpa batas. Pembayaran diproses melalui Midtrans. Semua transaksi bersifat final dan tidak dapat dikembalikan (non-refundable) setelah pembayaran berhasil.</p><h4 style="text-align:left; margin-top:15px;">3. Batasan Tanggung Jawab</h4><p style="text-align:left;">Pengembang tidak bertanggung jawab atas keputusan atau tindakan apa pun yang Anda ambil berdasarkan interpretasi dari hasil yang diberikan oleh aplikasi ini.</p><div class="popup-buttons" style="margin-top:20px;"><button class="btn close-popup-btn">Tutup</button></div></div></div>
    <div id="privacyPopup" class="popup-overlay hidden"><div class="popup-content popup-content-legal"><h2>Kebijakan Privasi</h2><p style="text-align:left;">Kami menghargai privasi Anda. Dokumen ini menjelaskan bagaimana kami mengumpulkan dan menggunakan data Anda.</p><h4 style="text-align:left; margin-top:15px;">1. Data yang Kami Kumpulkan</h4><p style="text-align:left;">Aplikasi ini menggunakan Firebase Anonymous Authentication. Kami mengumpulkan User ID anonim yang dibuat secara otomatis untuk setiap pengguna. Kami tidak mengumpulkan data pribadi seperti nama, email, atau nomor telepon, kecuali nama yang Anda masukkan secara sukarela untuk ditampilkan pada hasil ramalan.</p><h4 style="text-align:left; margin-top:15px;">2. Penggunaan Data</h4><p style="text-align:left;">User ID anonim digunakan untuk membedakan antara pengguna gratis dan premium, serta untuk melacak status "uji coba gratis". Data ini disimpan dengan aman di server Firebase dan tidak akan dibagikan kepada pihak ketiga.</p><div class="popup-buttons" style="margin-top:20px;"><button class="btn close-popup-btn">Tutup</button></div></div></div>

    <!-- Footer Aplikasi -->
    <footer><p>&copy; 2025 Ramalan Chiam Si. All Rights Reserved.</p><div style="margin-top: 10px;"><a id="termsLink">Syarat & Ketentuan</a> |<a id="privacyLink">Kebijakan Privasi</a> |<a href="mailto:dukungan.chiamsi@email.com">Kontak Kami</a></div></footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        // SEMUA LOGIKA JAVASCRIPT ADA DI SINI
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzYog6EbRLen7pg2aITsf5utEXQUVP3n0",
            authDomain: "ramalan-chiamsi-df5b0.firebaseapp.com",
            projectId: "ramalan-chiamsi-df5b0",
            storageBucket: "ramalan-chiamsi-df5b0.appspot.com",
            messagingSenderId: "152505108899",
            appId: "1:152505108899:web:b1e2e90ac2d7e722997216"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const createTransaction = httpsCallable(functions, 'createMidtransTransaction');

        const appContainer = document.getElementById('appContainer');
        const adminLoginSection = document.getElementById('adminLoginSection');
        const adminCmsSection = document.getElementById('adminCmsSection');
        const nameInput = document.getElementById('nameInput');
        const shakeBtn = document.getElementById('shakeBtn');
        const throwBtn = document.getElementById('throwBtn');
        const shakeResult = document.getElementById('shakeResult');
        const predictionNumber = document.getElementById('predictionNumber');
        const throwResult = document.getElementById('throwResult');
        const throwResultText = document.getElementById('throwResultText');
        const predictionResult = document.getElementById('predictionResult');
        const ciamsiContainer = document.getElementById('ciamsiContainer');
        const fallingStick = document.getElementById('fallingStick');
        const puakpois = [document.getElementById('puakpoi1'), document.getElementById('puakpoi2')];
        const throwCountElement = document.getElementById('throwCount');
        const resultNumber = document.getElementById('resultNumber');
        const sinthioText = document.getElementById('sinthioText');
        const syairText = document.getElementById('syairText');
        const selayangPandangText = document.getElementById('selayangPandangText');
        const pedomanList = document.getElementById('pedomanList');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const ramalanNumberSelect = document.getElementById('ramalanNumberSelect');
        const sinthioInput = document.getElementById('sinthioInput');
        const syairInput = document.getElementById('syairInput');
        const selayangPandangInput = document.getElementById('selayangPandangInput');
        const pedomanInput = document.getElementById('pedomanInput');
        const saveBtn = document.getElementById('saveBtn');
        const paymentPopup = document.getElementById('paymentPopup');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const messagePopup = document.getElementById('messagePopup');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const termsPopup = document.getElementById('termsPopup');
        const privacyPopup = document.getElementById('privacyPopup');
        const termsLink = document.getElementById('termsLink');
        const privacyLink = document.getElementById('privacyLink');
        const closePopupBtns = document.querySelectorAll('.close-popup-btn');

        let currentUser = null;
        let currentPredictionNumberState = null;
        let throwCount = 0;
        const maxThrowsFree = 3;
        let isPremiumUser = false;
        let hasHadFreeSuccess = false;

        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messagePopup.classList.remove('hidden');
        }
        closeMessageBtn.addEventListener('click', () => messagePopup.classList.add('hidden'));

        async function setupUserAndListener(userId) {
            const userDocRef = doc(db, "users", userId);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isPremiumUser = data.isPremium === true;
                    hasHadFreeSuccess = data.hasHadFreeSuccess === true;
                    if (isPremiumUser) paymentPopup.classList.add('hidden');
                } else {
                    setDoc(userDocRef, { isPremium: false, hasHadFreeSuccess: false, createdAt: new Date() });
                }
            });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                checkUrlHash();
            } else {
                signInAnonymously(auth).catch(error => console.error("Gagal login anonim:", error));
            }
        });

        function checkUrlHash() {
            const isAdminPage = window.location.hash === '#admin';
            if (isAdminPage) {
                appContainer.classList.add('hidden');
                if (currentUser && !currentUser.isAnonymous) {
                    adminCmsSection.classList.remove('hidden');
                    adminLoginSection.classList.add('hidden');
                    initCms();
                } else {
                    adminLoginSection.classList.remove('hidden');
                    adminCmsSection.classList.add('hidden');
                }
            } else {
                appContainer.classList.remove('hidden');
                adminLoginSection.classList.add('hidden');
                adminCmsSection.classList.add('hidden');
                if (currentUser && currentUser.isAnonymous) {
                    setupUserAndListener(currentUser.uid);
                }
            }
        }
        window.addEventListener('hashchange', checkUrlHash);
        window.addEventListener('load', checkUrlHash);

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => checkUrlHash())
                .catch(error => showMessage('Login Gagal', error.message));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.hash = '';
                checkUrlHash();
            });
        });

        async function initCms() {
            if (ramalanNumberSelect.options.length > 0) return;
            for (let i = 1; i <= 100; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Nomor ${i}`;
                ramalanNumberSelect.appendChild(option);
            }
            loadRamalanData(1);
        }

        ramalanNumberSelect.addEventListener('change', (e) => loadRamalanData(e.target.value));

        async function loadRamalanData(number) {
            try {
                const docRef = doc(db, "ramalan", String(number));
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    sinthioInput.value = data.sinthio || '';
                    syairInput.value = data.syair || '';
                    selayangPandangInput.value = data.selayangPandang || '';
                    pedomanInput.value = (data.pedoman || []).join('\n');
                } else {
                    sinthioInput.value = ''; syairInput.value = ''; selayangPandangInput.value = ''; pedomanInput.value = '';
                }
            } catch (error) { showMessage('Error', 'Gagal memuat data ramalan.'); }
        }

        saveBtn.addEventListener('click', async () => {
            const number = ramalanNumberSelect.value;
            const dataToSave = {
                nomor: parseInt(number),
                sinthio: sinthioInput.value,
                syair: syairInput.value,
                selayangPandang: selayangPandangInput.value,
                pedoman: pedomanInput.value.split('\n').filter(line => line.trim() !== '')
            };
            try {
                await setDoc(doc(db, "ramalan", number), dataToSave);
                showMessage('Sukses', `Data untuk nomor ${number} berhasil disimpan.`);
            } catch (error) { showMessage('Error', 'Gagal menyimpan data.'); }
        });

        function resetState() {
            throwCount = 0; throwCountElement.textContent = throwCount;
            throwBtn.disabled = true; shakeBtn.disabled = false;
            shakeResult.classList.add('hidden'); throwResult.classList.add('hidden');
            predictionResult.classList.add('hidden'); puakpois.forEach(p => p.textContent = '-');
            currentPredictionNumberState = null;
        }

        nameInput.addEventListener('input', () => { shakeBtn.disabled = nameInput.value.trim() === ''; });

        shakeBtn.addEventListener('click', () => {
            resetState();
            ciamsiContainer.classList.add('shake-animation');
            fallingStick.classList.remove('fall-animation'); fallingStick.style.opacity = 0;
            setTimeout(() => {
                ciamsiContainer.classList.remove('shake-animation');
                fallingStick.classList.add('fall-animation');
                const randomNumber = Math.floor(Math.random() * 100) + 1;
                predictionNumber.textContent = randomNumber;
                currentPredictionNumberState = randomNumber;
                shakeResult.classList.remove('hidden');
                throwBtn.disabled = false;
            }, 800);
        });

        throwBtn.addEventListener('click', async () => {
            throwBtn.disabled = true;
            throwCount++;
            throwCountElement.textContent = throwCount;
            
            puakpois.forEach(poi => {
                poi.textContent = '';
                poi.classList.add('throw-animation');
                setTimeout(() => poi.classList.remove('throw-animation'), 800);
            });

            setTimeout(async () => {
                let isConfirmed = false;
                if (!hasHadFreeSuccess) {
                    isConfirmed = true;
                    puakpois[0].textContent = '凹';
                    puakpois[1].textContent = '凸';
                } else {
                    const result1 = Math.round(Math.random());
                    const result2 = Math.round(Math.random());
                    puakpois[0].textContent = result1 === 0 ? '凹' : '凸';
                    puakpois[1].textContent = result2 === 0 ? '凹' : '凸';
                    isConfirmed = result1 !== result2;
                }
                
                if (isConfirmed) {
                    throwResultText.textContent = !hasHadFreeSuccess ? 'Hasil: Direstui Dewa! (Kesempatan Pertama)' : 'Hasil: Direstui Dewa!';
                    throwResult.classList.remove('hidden');
                    await showPrediction();
                } else {
                    if (!isPremiumUser && throwCount >= maxThrowsFree) {
                        paymentPopup.classList.remove('hidden');
                        throwResultText.textContent = 'Batas lemparan tercapai. Silakan upgrade.';
                    } else {
                        throwResultText.textContent = 'Hasil: Belum direstui. Coba lempar lagi.';
                        throwBtn.disabled = false;
                    }
                    throwResult.classList.remove('hidden');
                }
            }, 900);
        });

        async function showPrediction() {
            if (!currentPredictionNumberState) return;
            const docRef = doc(db, "ramalan", String(currentPredictionNumberState));
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    resultNumber.textContent = data.nomor || currentPredictionNumberState;
                    sinthioText.textContent = data.sinthio || 'Data belum diisi.';
                    syairText.textContent = data.syair || 'Data belum diisi.';
                    selayangPandangText.textContent = data.selayangPandang || 'Data belum diisi.';
                    pedomanList.innerHTML = '';
                    if (data.pedoman && data.pedoman.length > 0) {
                        data.pedoman.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            pedomanList.appendChild(li);
                        });
                    } else {
                        pedomanList.innerHTML = '<li>Data belum diisi.</li>';
                    }
                    predictionResult.classList.remove('hidden');

                    if (!hasHadFreeSuccess && currentUser) {
                        const userDocRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userDocRef, { hasHadFreeSuccess: true });
                        showMessage('Kesempatan Gratis Digunakan', 'Anda telah menggunakan kesempatan gratis Anda. Untuk ramalan berikutnya, aturan normal (batas 3x lemparan) akan berlaku.');
                    }
                } else {
                    showMessage('Data Kosong', `Data untuk ramalan nomor ${currentPredictionNumberState} belum diisi di CMS.`);
                    predictionResult.classList.add('hidden');
                }
            } catch (error) {
                showMessage('Error', 'Gagal mengambil data dari server.');
            }
        }
        
        document.getElementById('downloadBtn').addEventListener('click', () => {
            html2canvas(document.getElementById('predictionCard'), {
                backgroundColor: '#f8f4e9', scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Ramalan_CiamSi_${nameInput.value.trim().replace(/\s/g, '_')}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        });

        document.getElementById('whatsappShare').addEventListener('click', (e) => {
            e.preventDefault();
            const pedomanItems = [];
            document.querySelectorAll('#pedomanList li').forEach(li => {
                pedomanItems.push(`- ${li.textContent}`);
            });
            const pedomanText = pedomanItems.join('\n');

            const shareText = `*Ramalan Ciam Si untuk ${nameInput.value.trim()}*\n` +
                `*Nomor: ${currentPredictionNumberState}*\n\n` +
                `*Makna Lambang:*\n${sinthioText.textContent}\n\n` +
                `*Bunyi Syair:*\n${syairText.textContent}\n\n` +
                `*Selayang Pandang:*\n${selayangPandangText.textContent}\n\n` +
                `*Pedoman Jawaban:*\n${pedomanText}\n\n` +
                `Dapatkan ramalan Anda di: ${window.location.href.split('#')[0]}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
            window.open(whatsappUrl, '_blank');
        });

        closePopupBtn.addEventListener('click', () => paymentPopup.classList.add('hidden'));
        document.getElementById('upgradeBtn').addEventListener('click', async () => {
            const upgradeBtn = document.getElementById('upgradeBtn');
            upgradeBtn.disabled = true;
            upgradeBtn.textContent = "Memproses...";
            try {
                const result = await createTransaction({ name: nameInput.value });
                const token = result.data.token;
                window.snap.pay(token, {
                    onSuccess: function(result){ showMessage('Sukses', 'Pembayaran berhasil! Akun Anda telah di-upgrade.'); paymentPopup.classList.add('hidden'); },
                    onPending: function(result){ showMessage('Pending', 'Menunggu konfirmasi pembayaran.'); paymentPopup.classList.add('hidden'); },
                    onError: function(result){ showMessage('Gagal', 'Pembayaran gagal. Silakan coba lagi.'); },
                    onClose: function(){ console.log('Popup pembayaran ditutup.'); }
                });
            } catch(error) {
                showMessage('Error', 'Gagal membuat transaksi. Silakan coba lagi nanti.');
            } finally {
                upgradeBtn.disabled = false;
                upgradeBtn.textContent = "Upgrade Sekarang";
            }
        });
        
        termsLink.addEventListener('click', () => termsPopup.classList.remove('hidden'));
        privacyLink.addEventListener('click', () => privacyPopup.classList.remove('hidden'));
        closePopupBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.popup-overlay').classList.add('hidden');
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>

